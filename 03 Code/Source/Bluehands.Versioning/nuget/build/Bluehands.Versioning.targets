<?xml version="1.0" encoding="utf-8" ?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <PropertyGroup>
    <BluehandsVersioningAssembly>$(MSBuildThisFileDirectory)\..\tools\Bluehands.Versioning.dll</BluehandsVersioningAssembly>
  </PropertyGroup>
  <UsingTask AssemblyFile="$(BluehandsVersioningAssembly)" TaskName="ReadVersionFile"/>
  <UsingTask AssemblyFile="$(BluehandsVersioningAssembly)" TaskName="RemoveLines"/>

  <PropertyGroup>
    <VersionTemplateFilenames Condition=" '$(VersionTemplateFilenames)' == '' ">AssemblyVersionInfoTemplate.txt;Version.txt</VersionTemplateFilenames>
    <VersionTemplateFolders Condition=" '$(VersionTemplateFolders)' == '' ">$(ProjectDir)Properties;$(ProjectDir);$(SolutionDir)</VersionTemplateFolders>
    <VersionTemplateSegmentCount Condition=" '$(VersionTemplateSegmentCount)' == '' ">3</VersionTemplateSegmentCount>
    <AssemblyVersionInfoFile Condition=" '$(AssemblyVersionInfoFile)' == '' ">$(ProjectDir)Properties\AssemblyVersionInfo.cs</AssemblyVersionInfoFile>
    <AssemblyInfoFile Condition=" '$(AssemblyInfoFile)' == '' ">$(ProjectDir)Properties\AssemblyInfo.cs</AssemblyInfoFile>
    <AssemblyVersionAttributePatterns Condition=" '$(AssemblyVersionAttributePatterns)' == '' ">^[^\/].*[\s.:](AssemblyVersion|AssemblyFileVersion|AssemblyInformationalVersion)([\s(]|Attribute[\s(])</AssemblyVersionAttributePatterns>
  </PropertyGroup>
  <Target Name="BeforeBuild">
    <ReadVersionFile Folders="$(VersionTemplateFolders)" Filenames="$(VersionTemplateFilenames)" SegmentCount="$(VersionTemplateSegmentCount)">
      <Output TaskParameter="VersionPrefix" PropertyName="VersionPrefix" />
    </ReadVersionFile>
    <GitCommits LocalPath="$(ProjectDir)">
      <Output TaskParameter="CommitsCount" PropertyName="GitCommitsCount" />
    </GitCommits>
    <GitBranch LocalPath="$(ProjectDir)">
      <Output TaskParameter="Branch" PropertyName="GitBranchName" />
    </GitBranch>
    <GitVersion LocalPath="$(ProjectDir)" Short="false">
      <Output TaskParameter="CommitHash" PropertyName="GitCommitHash" />
    </GitVersion>
    <Time Format="yyyyMMdd-HHmmss">
      <Output TaskParameter="FormattedTime" PropertyName="BuildDate" />
    </Time>
    <PropertyGroup>
      <FullVersion>$(VersionPrefix).$(GitCommitsCount)</FullVersion>
      <BuildInfo>$(GitBranchName)-$(GitCommitHash)-$(BuildDate)</BuildInfo>
    </PropertyGroup>
    <Message Text="Version: $(FullVersion)-$(BuildInfo)" />
    <AssemblyInfo CodeLanguage="CS" OutputFile="$(AssemblyVersionInfoFile)" AssemblyVersion="$(FullVersion)" AssemblyFileVersion="$(FullVersion)" AssemblyInformationalVersion="$(BuildInfo)" />
    <RemoveLines Files="$(AssemblyInfoFile)" Patterns="$(AssemblyVersionAttributePatterns)" />
  </Target>
</Project>
